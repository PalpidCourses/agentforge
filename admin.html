<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentForge — Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f; --surface: #12121a; --surface2: #1a1a26; --border: #2a2a3a;
  --text: #e4e4ef; --text-dim: #7a7a92; --accent: #00ff88; --accent-dim: #00cc6a;
  --accent-glow: rgba(0,255,136,0.15); --red: #ff4444; --yellow: #ffcc00; --blue: #4488ff;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:'Space Grotesk',sans-serif; line-height:1.6; }
.noise { position:fixed; top:0;left:0;right:0;bottom:0; background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events:none; z-index:999; }
.grid-bg { position:fixed; top:0;left:0;right:0;bottom:0; background-image:linear-gradient(rgba(0,255,136,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,136,0.03) 1px,transparent 1px); background-size:60px 60px; pointer-events:none; }

header { position:fixed; top:0; width:100%; padding:0.75rem 2rem; background:rgba(10,10,15,0.9); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); z-index:100; display:flex; justify-content:space-between; align-items:center; }
.logo { font-family:'JetBrains Mono',monospace; font-weight:700; font-size:1.2rem; color:var(--accent); text-decoration:none; }
.logo span { color:var(--text-dim); }
.header-right { display:flex; align-items:center; gap:1rem; }
.status-badge { display:flex; align-items:center; gap:8px; font-family:'JetBrains Mono',monospace; font-size:0.7rem; color:var(--accent); padding:4px 12px; border:1px solid rgba(0,255,136,0.2); border-radius:20px; background:var(--accent-glow); }
.status-dot { width:6px; height:6px; background:var(--accent); border-radius:50%; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,255,136,0.4)} 50%{opacity:0.7;box-shadow:0 0 0 6px rgba(0,255,136,0)} }
.logout-btn { font-family:'JetBrains Mono',monospace; font-size:0.7rem; padding:4px 12px; background:transparent; color:var(--text-dim); border:1px solid var(--border); border-radius:6px; cursor:pointer; transition:all 0.2s; }
.logout-btn:hover { border-color:var(--red); color:var(--red); }

.dashboard { position:relative; z-index:10; padding:5rem 2rem 3rem; max-width:1300px; margin:0 auto; }
h1 { font-size:1.6rem; font-weight:600; letter-spacing:-1px; margin-bottom:0.25rem; }
.dash-sub { color:var(--text-dim); font-size:0.8rem; margin-bottom:1.5rem; font-family:'JetBrains Mono',monospace; }

/* Stat cards */
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:0.75rem; margin-bottom:2rem; }
.stat-card { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:1rem; }
.stat-card:hover { border-color:rgba(0,255,136,0.3); }
.stat-label { font-family:'JetBrains Mono',monospace; font-size:0.6rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:0.25rem; }
.stat-value { font-size:1.6rem; font-weight:700; color:var(--accent); font-family:'JetBrains Mono',monospace; }
.stat-value.blue { color:var(--blue); }
.stat-value.yellow { color:var(--yellow); }

/* Tabs */
.tabs { display:flex; gap:0; border-bottom:2px solid var(--border); margin-bottom:1.5rem; overflow-x:auto; }
.tab { font-family:'JetBrains Mono',monospace; font-size:0.75rem; padding:10px 18px; background:transparent; color:var(--text-dim); border:none; cursor:pointer; transition:all 0.2s; border-bottom:2px solid transparent; margin-bottom:-2px; white-space:nowrap; }
.tab:hover { color:var(--text); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.tab-count { font-size:0.6rem; background:var(--accent-glow); color:var(--accent); padding:1px 6px; border-radius:8px; margin-left:6px; }

/* Table */
.table-wrap { background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow:hidden; margin-bottom:1.5rem; }
.data-table { width:100%; border-collapse:collapse; font-size:0.8rem; }
.data-table th { text-align:left; padding:0.75rem 1rem; border-bottom:2px solid var(--border); color:var(--text-dim); font-family:'JetBrains Mono',monospace; font-size:0.65rem; text-transform:uppercase; letter-spacing:1px; }
.data-table td { padding:0.6rem 1rem; border-bottom:1px solid var(--border); max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.data-table tr:last-child td { border-bottom:none; }
.data-table tr:hover { background:rgba(0,255,136,0.02); }
.mono { font-family:'JetBrains Mono',monospace; font-size:0.75rem; }
.id-cell { color:var(--accent); font-family:'JetBrains Mono',monospace; font-size:0.75rem; cursor:pointer; }
.id-cell:hover { text-decoration:underline; }
.badge { display:inline-block; font-family:'JetBrains Mono',monospace; font-size:0.6rem; padding:2px 8px; border-radius:4px; }
.badge-green { color:var(--accent); background:var(--accent-glow); }
.badge-yellow { color:var(--yellow); background:rgba(255,204,0,0.1); }
.badge-blue { color:var(--blue); background:rgba(68,136,255,0.1); }
.badge-dim { color:var(--text-dim); background:rgba(122,122,146,0.1); }
.delete-btn { font-family:'JetBrains Mono',monospace; font-size:0.65rem; padding:4px 10px; background:transparent; color:var(--text-dim); border:1px solid var(--border); border-radius:4px; cursor:pointer; }
.delete-btn:hover { border-color:var(--red); color:var(--red); background:rgba(255,68,68,0.1); }

/* Payload viewer */
.payload-cell { max-width:400px; }
.payload-preview { color:var(--text-dim); font-family:'JetBrains Mono',monospace; font-size:0.7rem; cursor:pointer; }
.payload-preview:hover { color:var(--accent); }

/* Filter bar */
.filter-bar { display:flex; gap:0.75rem; margin-bottom:1rem; flex-wrap:wrap; align-items:center; }
.filter-bar input, .filter-bar select { background:var(--surface); border:1px solid var(--border); color:var(--text); padding:6px 12px; border-radius:6px; font-family:'JetBrains Mono',monospace; font-size:0.75rem; outline:none; }
.filter-bar input:focus, .filter-bar select:focus { border-color:var(--accent); }
.filter-label { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--text-dim); text-transform:uppercase; }

/* Pagination */
.pagination { display:flex; justify-content:space-between; align-items:center; margin-top:1rem; font-family:'JetBrains Mono',monospace; font-size:0.75rem; color:var(--text-dim); }
.page-btn { background:var(--surface); border:1px solid var(--border); color:var(--text); padding:4px 12px; border-radius:4px; cursor:pointer; font-family:'JetBrains Mono',monospace; font-size:0.7rem; }
.page-btn:hover { border-color:var(--accent); color:var(--accent); }
.page-btn:disabled { opacity:0.3; cursor:not-allowed; }

.empty { text-align:center; padding:2.5rem; color:var(--text-dim); font-family:'JetBrains Mono',monospace; font-size:0.8rem; }
.loading { display:flex; align-items:center; justify-content:center; min-height:40vh; font-family:'JetBrains Mono',monospace; color:var(--text-dim); }
.spinner { width:18px; height:18px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; margin-right:0.75rem; }
@keyframes spin { to{transform:rotate(360deg)} }
.refresh-info { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--text-dim); text-align:center; margin-top:1.5rem; }
.refresh-info span { color:var(--accent); }

/* Modal */
.modal-overlay { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.7); z-index:200; align-items:center; justify-content:center; }
.modal-overlay.active { display:flex; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:2rem; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
.modal h3 { font-size:1rem; margin-bottom:0.75rem; }
.modal-pre { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:1rem; font-family:'JetBrains Mono',monospace; font-size:0.75rem; white-space:pre-wrap; word-break:break-all; max-height:400px; overflow-y:auto; color:var(--text); margin:0.75rem 0; }
.modal-actions { display:flex; gap:0.75rem; justify-content:flex-end; margin-top:1rem; }
.modal-close { font-family:'JetBrains Mono',monospace; font-size:0.8rem; padding:8px 18px; background:var(--surface2); color:var(--text); border:1px solid var(--border); border-radius:6px; cursor:pointer; }
.modal-danger { font-family:'JetBrains Mono',monospace; font-size:0.8rem; padding:8px 18px; background:var(--red); color:#fff; border:none; border-radius:6px; cursor:pointer; }

@media(max-width:768px) {
  header{padding:0.75rem 1rem} .dashboard{padding:4.5rem 1rem 2rem} .stats-grid{grid-template-columns:repeat(2,1fr)}
  .data-table{font-size:0.7rem} .data-table th,.data-table td{padding:0.5rem 0.6rem} .hide-mobile{display:none}
}
</style>
</head>
<body>
<div class="noise"></div>
<div class="grid-bg"></div>

<header>
  <a href="/" class="logo">AgentForge<span>.admin</span></a>
  <div class="header-right">
    <div class="status-badge"><div class="status-dot"></div><span id="versionBadge">loading...</span></div>
    <button class="logout-btn" onclick="handleLogout()">Logout</button>
  </div>
</header>

<div class="dashboard" id="dashboard">
  <div class="loading" id="loadingState"><div class="spinner"></div>Loading dashboard...</div>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal" id="modalContent"></div>
</div>

<script>
const S = {}; // state
let currentTab = 'overview';
let pageOffsets = { messages:0, memory:0, queue:0, shared:0 };

// ── Fetch helpers ──
async function api(path) {
  const r = await fetch(path, {credentials:'same-origin'});
  if (r.status === 401) { window.location.href='/admin/login'; return null; }
  return r.ok ? r.json() : null;
}

async function apiDelete(path) {
  const r = await fetch(path, {method:'DELETE', credentials:'same-origin'});
  return r.ok;
}

// ── Load data ──
async function loadDashboard() {
  const data = await api('/admin/api/dashboard');
  if (!data) return;
  S.dashboard = data;
  render();
}

async function loadTab(tab) {
  currentTab = tab;
  if (tab === 'overview') { render(); return; }
  const map = {
    messages: '/admin/api/messages', memory: '/admin/api/memory',
    queue: '/admin/api/queue', webhooks: '/admin/api/webhooks',
    schedules: '/admin/api/schedules', shared: '/admin/api/shared-memory',
  };
  let url = map[tab] + `?limit=100&offset=${pageOffsets[tab]||0}`;
  if (S.filterAgent) url += `&agent_id=${S.filterAgent}`;
  if (tab === 'queue' && S.filterStatus) url += `&status=${S.filterStatus}`;
  if (tab === 'shared' && S.filterNamespace) url += `&namespace=${S.filterNamespace}`;
  const data = await api(url);
  if (data) { S[tab] = data; render(); }
}

// ── Render ──
function render() {
  if (!S.dashboard) return;
  const d = S.dashboard, s = d.stats;
  document.getElementById('versionBadge').textContent = `v${d.version} \u2022 admin`;

  let h = `<h1>Admin Dashboard</h1><p class="dash-sub">${new Date(d.timestamp).toLocaleString()}</p>`;
  h += `<div class="stats-grid">
    ${statCard('Agents',s.total_agents)} ${statCard('Public',s.public_agents)}
    ${statCard('Jobs',s.total_jobs,'blue')} ${statCard('Pending',s.pending_jobs,'yellow')}
    ${statCard('Memory',s.memory_keys)} ${statCard('Shared',s.shared_memory_keys)}
    ${statCard('Messages',s.messages_relayed,'blue')} ${statCard('WS Conns',s.websocket_connections)}
    ${statCard('Webhooks',s.active_webhooks)} ${statCard('Schedules',s.active_schedules)}
  </div>`;

  // Tabs
  const tabs = [
    ['overview','Overview'], ['messages','Messages',s.messages_relayed], ['memory','Memory',s.memory_keys],
    ['queue','Queue',s.total_jobs], ['webhooks','Webhooks',s.active_webhooks],
    ['schedules','Schedules',s.active_schedules], ['shared','Shared Memory',s.shared_memory_keys],
  ];
  h += '<div class="tabs">';
  for (const [id,label,count] of tabs) {
    h += `<button class="tab ${currentTab===id?'active':''}" onclick="loadTab('${id}')">${label}${count!==undefined?`<span class="tab-count">${count}</span>`:''}</button>`;
  }
  h += '</div>';

  // Tab content
  if (currentTab === 'overview') h += renderOverview(d);
  else if (currentTab === 'messages') h += renderMessages();
  else if (currentTab === 'memory') h += renderMemory();
  else if (currentTab === 'queue') h += renderQueue();
  else if (currentTab === 'webhooks') h += renderWebhooks();
  else if (currentTab === 'schedules') h += renderSchedules();
  else if (currentTab === 'shared') h += renderShared();

  h += '<div class="refresh-info">Auto-refresh every <span>15s</span></div>';
  document.getElementById('dashboard').innerHTML = h;
}

function statCard(label,val,color) {
  return `<div class="stat-card"><div class="stat-label">${label}</div><div class="stat-value ${color||''}">${val}</div></div>`;
}
function esc(s) { return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
function timeAgo(iso) {
  if(!iso)return'never'; const d=(Date.now()-new Date(iso).getTime())/1000;
  if(d<60)return Math.floor(d)+'s ago'; if(d<3600)return Math.floor(d/60)+'m ago';
  if(d<86400)return Math.floor(d/3600)+'h ago'; return Math.floor(d/86400)+'d ago';
}
function shortId(id) { return id && id.length > 20 ? id.slice(0,20)+'...' : id; }
function preview(s, n=80) { return s && s.length > n ? s.slice(0,n)+'...' : s||''; }
function statusBadge(st) {
  if(st==='completed') return '<span class="badge badge-green">completed</span>';
  if(st==='processing') return '<span class="badge badge-yellow">processing</span>';
  if(st==='pending') return '<span class="badge badge-blue">pending</span>';
  return `<span class="badge badge-dim">${esc(st)}</span>`;
}

function agentFilter() {
  const agents = S.dashboard?.agents || [];
  let h = '<select onchange="S.filterAgent=this.value;pageOffsets[currentTab]=0;loadTab(currentTab)">';
  h += '<option value="">All agents</option>';
  for (const a of agents) h += `<option value="${esc(a.agent_id)}" ${S.filterAgent===a.agent_id?'selected':''}>${esc(a.name||a.agent_id)}</option>`;
  return h + '</select>';
}

function paginator(data, key) {
  if (!data) return '';
  const off = pageOffsets[key]||0;
  return `<div class="pagination">
    <span>Showing ${off+1}-${Math.min(off+data.limit,data.total)} of ${data.total}</span>
    <div>
      <button class="page-btn" ${off===0?'disabled':''} onclick="pageOffsets['${key}']-=100;loadTab('${key}')">Prev</button>
      <button class="page-btn" ${off+data.limit>=data.total?'disabled':''} onclick="pageOffsets['${key}']+=100;loadTab('${key}')">Next</button>
    </div>
  </div>`;
}

// ── Tab renderers ──
function renderOverview(d) {
  if (!d.agents.length) return '<div class="empty">No agents registered yet</div>';
  let h = '<div class="table-wrap"><table class="data-table"><thead><tr><th>Agent ID</th><th>Name</th><th class="hide-mobile">Description</th><th>Visibility</th><th>Requests</th><th class="hide-mobile">Last Seen</th><th></th></tr></thead><tbody>';
  for (const a of d.agents) {
    h += `<tr>
      <td><span class="id-cell" onclick="viewAgent('${esc(a.agent_id)}')">${esc(shortId(a.agent_id))}</span></td>
      <td class="mono">${a.name?esc(a.name):'<span style="color:var(--text-dim)">unnamed</span>'}</td>
      <td class="hide-mobile" style="color:var(--text-dim);font-size:0.75rem">${esc(preview(a.description,50))}</td>
      <td>${a.public?'<span class="badge badge-green">PUBLIC</span>':'<span class="badge badge-dim">PRIVATE</span>'}</td>
      <td class="mono">${a.request_count||0}</td>
      <td class="hide-mobile mono" style="color:var(--text-dim)">${timeAgo(a.last_seen)}</td>
      <td><button class="delete-btn" onclick="confirmDeleteAgent('${esc(a.agent_id)}')">Delete</button></td>
    </tr>`;
  }
  return h + '</tbody></table></div>';
}

function renderMessages() {
  const data = S.messages;
  if (!data) return '<div class="loading"><div class="spinner"></div>Loading...</div>';
  let h = `<div class="filter-bar">${agentFilter()}</div>`;
  if (!data.messages.length) return h + '<div class="empty">No messages</div>';
  h += '<div class="table-wrap"><table class="data-table"><thead><tr><th>ID</th><th>From</th><th>To</th><th>Channel</th><th>Payload</th><th class="hide-mobile">Sent</th><th class="hide-mobile">Read</th></tr></thead><tbody>';
  for (const m of data.messages) {
    h += `<tr>
      <td class="mono" style="color:var(--accent)">${esc(shortId(m.message_id))}</td>
      <td class="mono">${esc(shortId(m.from_agent))}</td>
      <td class="mono">${esc(shortId(m.to_agent))}</td>
      <td class="mono">${esc(m.channel)}</td>
      <td class="payload-cell"><span class="payload-preview" onclick="viewPayload('Message',${JSON.stringify(JSON.stringify(m.payload))})">${esc(preview(m.payload))}</span></td>
      <td class="hide-mobile mono" style="color:var(--text-dim)">${timeAgo(m.created_at)}</td>
      <td class="hide-mobile">${m.read_at?'<span class="badge badge-green">read</span>':'<span class="badge badge-dim">unread</span>'}</td>
    </tr>`;
  }
  return h + '</tbody></table></div>' + paginator(data,'messages');
}

function renderMemory() {
  const data = S.memory;
  if (!data) return '<div class="loading"><div class="spinner"></div>Loading...</div>';
  let h = `<div class="filter-bar">${agentFilter()}</div>`;
  if (!data.entries.length) return h + '<div class="empty">No memory entries</div>';
  h += '<div class="table-wrap"><table class="data-table"><thead><tr><th>Agent</th><th>Namespace</th><th>Key</th><th>Value</th><th class="hide-mobile">Updated</th><th class="hide-mobile">Expires</th></tr></thead><tbody>';
  for (const e of data.entries) {
    h += `<tr>
      <td class="mono" style="color:var(--accent)">${esc(shortId(e.agent_id))}</td>
      <td class="mono">${esc(e.namespace)}</td>
      <td class="mono">${esc(e.key)}</td>
      <td class="payload-cell"><span class="payload-preview" onclick="viewPayload('Memory: ${esc(e.key)}',${JSON.stringify(JSON.stringify(e.value))})">${esc(preview(e.value))}</span></td>
      <td class="hide-mobile mono" style="color:var(--text-dim)">${timeAgo(e.updated_at)}</td>
      <td class="hide-mobile mono" style="color:var(--text-dim)">${e.expires_at?timeAgo(e.expires_at):'never'}</td>
    </tr>`;
  }
  return h + '</tbody></table></div>' + paginator(data,'memory');
}

function renderQueue() {
  const data = S.queue;
  if (!data) return '<div class="loading"><div class="spinner"></div>Loading...</div>';
  let h = `<div class="filter-bar">${agentFilter()}
    <select onchange="S.filterStatus=this.value;pageOffsets.queue=0;loadTab('queue')">
      <option value="">All statuses</option><option value="pending" ${S.filterStatus==='pending'?'selected':''}>Pending</option>
      <option value="processing" ${S.filterStatus==='processing'?'selected':''}>Processing</option>
      <option value="completed" ${S.filterStatus==='completed'?'selected':''}>Completed</option>
    </select></div>`;
  if (!data.jobs.length) return h + '<div class="empty">No jobs</div>';
  h += '<div class="table-wrap"><table class="data-table"><thead><tr><th>Job ID</th><th>Agent</th><th>Queue</th><th>Status</th><th>Priority</th><th>Payload</th><th class="hide-mobile">Created</th></tr></thead><tbody>';
  for (const j of data.jobs) {
    h += `<tr>
      <td class="mono" style="color:var(--accent)">${esc(shortId(j.job_id))}</td>
      <td class="mono">${esc(shortId(j.agent_id))}</td>
      <td class="mono">${esc(j.queue_name)}</td>
      <td>${statusBadge(j.status)}</td>
      <td class="mono">${j.priority}</td>
      <td class="payload-cell"><span class="payload-preview" onclick="viewPayload('Job ${esc(shortId(j.job_id))}',${JSON.stringify(JSON.stringify(j.payload))})">${esc(preview(j.payload))}</span></td>
      <td class="hide-mobile mono" style="color:var(--text-dim)">${timeAgo(j.created_at)}</td>
    </tr>`;
  }
  return h + '</tbody></table></div>' + paginator(data,'queue');
}

function renderWebhooks() {
  const data = S.webhooks;
  if (!data) return '<div class="loading"><div class="spinner"></div>Loading...</div>';
  if (!data.webhooks.length) return '<div class="empty">No webhooks</div>';
  let h = '<div class="table-wrap"><table class="data-table"><thead><tr><th>ID</th><th>Agent</th><th>URL</th><th>Events</th><th>Active</th><th class="hide-mobile">Created</th></tr></thead><tbody>';
  for (const w of data.webhooks) {
    h += `<tr>
      <td class="mono" style="color:var(--accent)">${esc(shortId(w.webhook_id))}</td>
      <td class="mono">${esc(shortId(w.agent_id))}</td>
      <td class="mono" style="max-width:250px;overflow:hidden;text-overflow:ellipsis">${esc(w.url)}</td>
      <td>${(w.event_types||[]).map(e=>'<span class="badge badge-blue">'+esc(e)+'</span> ').join('')}</td>
      <td>${w.active?'<span class="badge badge-green">yes</span>':'<span class="badge badge-dim">no</span>'}</td>
      <td class="hide-mobile mono" style="color:var(--text-dim)">${timeAgo(w.created_at)}</td>
    </tr>`;
  }
  return h + '</tbody></table></div>';
}

function renderSchedules() {
  const data = S.schedules;
  if (!data) return '<div class="loading"><div class="spinner"></div>Loading...</div>';
  if (!data.schedules.length) return '<div class="empty">No scheduled tasks</div>';
  let h = '<div class="table-wrap"><table class="data-table"><thead><tr><th>ID</th><th>Agent</th><th>Cron</th><th>Queue</th><th>Enabled</th><th>Runs</th><th class="hide-mobile">Next Run</th></tr></thead><tbody>';
  for (const s of data.schedules) {
    h += `<tr>
      <td class="mono" style="color:var(--accent)">${esc(shortId(s.task_id))}</td>
      <td class="mono">${esc(shortId(s.agent_id))}</td>
      <td class="mono">${esc(s.cron_expr)}</td>
      <td class="mono">${esc(s.queue_name)}</td>
      <td>${s.enabled?'<span class="badge badge-green">yes</span>':'<span class="badge badge-dim">no</span>'}</td>
      <td class="mono">${s.run_count||0}</td>
      <td class="hide-mobile mono" style="color:var(--text-dim)">${timeAgo(s.next_run_at)}</td>
    </tr>`;
  }
  return h + '</tbody></table></div>';
}

function renderShared() {
  const data = S.shared;
  if (!data) return '<div class="loading"><div class="spinner"></div>Loading...</div>';
  let h = '<div class="filter-bar"><input placeholder="Filter namespace..." value="'+(S.filterNamespace||'')+'" onchange="S.filterNamespace=this.value;pageOffsets.shared=0;loadTab(\'shared\')"></div>';
  if (!data.entries.length) return h + '<div class="empty">No shared memory entries</div>';
  h += '<div class="table-wrap"><table class="data-table"><thead><tr><th>Owner</th><th>Namespace</th><th>Key</th><th>Value</th><th class="hide-mobile">Description</th><th class="hide-mobile">Updated</th></tr></thead><tbody>';
  for (const e of data.entries) {
    h += `<tr>
      <td class="mono" style="color:var(--accent)">${esc(shortId(e.owner_agent))}</td>
      <td class="mono">${esc(e.namespace)}</td>
      <td class="mono">${esc(e.key)}</td>
      <td class="payload-cell"><span class="payload-preview" onclick="viewPayload('Shared: ${esc(e.namespace)}/${esc(e.key)}',${JSON.stringify(JSON.stringify(e.value))})">${esc(preview(e.value))}</span></td>
      <td class="hide-mobile" style="color:var(--text-dim);font-size:0.75rem">${esc(preview(e.description,40))}</td>
      <td class="hide-mobile mono" style="color:var(--text-dim)">${timeAgo(e.updated_at)}</td>
    </tr>`;
  }
  return h + '</tbody></table></div>' + paginator(data,'shared');
}

// ── Actions ──
function viewPayload(title, content) {
  let pretty = content;
  try { pretty = JSON.stringify(JSON.parse(content), null, 2); } catch(e) {}
  document.getElementById('modalContent').innerHTML = `
    <h3>${esc(title)}</h3>
    <div class="modal-pre">${esc(pretty)}</div>
    <div class="modal-actions"><button class="modal-close" onclick="closeModal()">Close</button></div>`;
  document.getElementById('modal').classList.add('active');
}

async function viewAgent(agentId) {
  const data = await api(`/admin/api/agents/${agentId}`);
  if (!data) return;
  const a = data.agent;
  let h = `<h3>Agent: ${esc(a.name||a.agent_id)}</h3><div class="modal-pre">${esc(JSON.stringify(a,null,2))}</div>`;
  h += `<p class="mono" style="color:var(--text-dim);margin:0.5rem 0">Memory: ${data.memory.length} | Jobs: ${data.jobs.length} | Sent: ${data.messages_sent.length} | Received: ${data.messages_received.length} | Webhooks: ${data.webhooks.length} | Schedules: ${data.schedules.length} | Shared: ${data.shared_memory.length}</p>`;
  if (data.messages_sent.length + data.messages_received.length > 0) {
    h += '<h3 style="margin-top:1rem">Messages</h3><div class="modal-pre">';
    for (const m of [...data.messages_sent,...data.messages_received].sort((a,b)=>b.created_at.localeCompare(a.created_at)).slice(0,20)) {
      const dir = m.from_agent === agentId ? '\u2192 ' + m.to_agent : '\u2190 ' + m.from_agent;
      h += `${esc(m.created_at.slice(0,19))} [${esc(m.channel)}] ${esc(dir)}\n${esc(m.payload)}\n\n`;
    }
    h += '</div>';
  }
  if (data.memory.length > 0) {
    h += '<h3 style="margin-top:1rem">Memory</h3><div class="modal-pre">';
    for (const e of data.memory) h += `[${esc(e.namespace)}] ${esc(e.key)} = ${esc(preview(e.value,200))}\n`;
    h += '</div>';
  }
  h += `<div class="modal-actions"><button class="modal-close" onclick="closeModal()">Close</button>
    <button class="modal-danger" onclick="confirmDeleteAgent('${esc(agentId)}');closeModal()">Delete Agent</button></div>`;
  document.getElementById('modalContent').innerHTML = h;
  document.getElementById('modal').classList.add('active');
}

function confirmDeleteAgent(agentId) {
  document.getElementById('modalContent').innerHTML = `
    <h3>Delete Agent</h3>
    <p style="color:var(--text-dim)">Permanently delete <span class="mono" style="color:var(--accent)">${esc(agentId)}</span> and all associated data?</p>
    <div class="modal-actions">
      <button class="modal-close" onclick="closeModal()">Cancel</button>
      <button class="modal-danger" onclick="doDelete('${esc(agentId)}')">Delete</button>
    </div>`;
  document.getElementById('modal').classList.add('active');
}

async function doDelete(agentId) {
  await apiDelete(`/admin/api/agents/${agentId}`);
  closeModal();
  loadDashboard();
}

function closeModal() { document.getElementById('modal').classList.remove('active'); }
async function handleLogout() { await fetch('/admin/api/logout',{method:'POST',credentials:'same-origin'}); window.location.href='/admin/login'; }

// ── Init ──
loadDashboard();
setInterval(() => { loadDashboard(); if (currentTab !== 'overview') loadTab(currentTab); }, 15000);
document.getElementById('modal').addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });
</script>
</body>
</html>
